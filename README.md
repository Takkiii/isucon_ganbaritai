# isucon_ganbaritai

## 基本原則
> オペレーション（System Engineering）で点を守り、 プログラミング（Software Engineering）で点をとる

### 理由

> OS・ミドルウェアのチューニングが劇的な加点要素になることはあまりありません。 そのレイヤのチューニングはリソース消費量を小さくすることに寄与することが多いためです。

## やること

### 環境構築

> 予選の場合は、クラウド環境セットアップが必要です。ISUCON3、ISUCON4ではAWS、ISUCON5ではGCE、ISUCON6はAzureです。 アカウント作成やインスタンス作成がメインです。 当日のレギュレーションにも一応手順は記載されるはずですが、事前に触っておくと本番で混乱せずに済むと思います。

### サーバログイン環境

> 例年であれば、/home/isucon 以下に必要なアプリケーション一式が入っています。isuconユーザがもしなければ (useradd -d /home/isucon -m isucon) などで作成します。 さらに、/home/isucon/.ssh 以下に公開鍵認証するための公開鍵を設置します。 /home/isucon/.ssh/authorized_keysファイルを作成し、.sshディレクトリのパーミッションは700、authorized_keysファイルのパーミッションは600であることを確認します。（この辺のパーミッションがおかしいとログインできない） メンバー分のユーザを作成するのは面倒なので、共通ユーザ1つだけで問題ないと思います。

### デプロイ自動化

> Capistranoのような大げさなものは使わなくて良いので、以下のような雑スクリプトでデプロイを自動化しましょう。

```sh
#!/bin/bash
set -ex
IPADDR=$1
USERNAME=$USER
ssh isucon@$IPADDR "/home/isucon/notify.sh $USERNAME 'deploying...' && cd /home/isucon/deploy && git pull && ~/.local/perl/bin/carton install && sudo systemctl restart mysql && sudo service memcached restart && sudo systemctl restart isuxi.perl && sudo systemctl restart nginx && sudo sysctl -p && /home/isucon/notify.sh $USERNAME 'deploy done'"
```

> やっていることはSlackへ開始デプロイ通知、git pull、MySQL、Redis、memcached、app、nginxの再起動、Slackへデプロイ完了通知ぐらいです。 MySQLやnginxもいれているのは、設定ファイルを更新したはいいが、再起動をし忘れるということがよくあるので、まとめて再起動してしまいます。 接続先のプロセスがしぬと、うまく再接続されない場合もなくはないので、再起動するのは原則バックエンドからが一応よいです。

### リソース利用率把握とログの確認

> (中略)リソース消費量を把握しておくことはボトルネック特定のヒントになるので重要です。 例えば、予選問題の初期状態ではMySQLのCPU負荷が支配的であることが多いかつディスクI/Oが高ければ、まずMySQLのバッファプールを増やしたり、クエリ改善が必要そうという程度のことはすぐわかります。 ISUCON4で話題になったCache-Controlの件も、ネットワーク帯域が限界であることにもっと早く気づいていれば、何かしら手は打てたかもと思います。

### 監視

### MySQLデータサイズ確認

> MySQLのデータサイズとして、テーブルごとのサイズや行数などを把握しておくと、クエリ改善の参考にできる。 行数が小さければ、多少クエリが悪くてもスコアへの影響は小さいため、後回しにできる。

### アクセスログの解析

> proxyでアクセスログを解析することにより、URLごとのリクエスト数やレスポンスタイムを集計できます。解析には、tkuchikiさんのalpが便利です。 自分の場合は、適当な自作スクリプトを使っていました。

### MySQLスロークエリログの解析

> MySQLのスロークエリログは、実行時間が閾値以上のクエリのログを吐いてくれるというものです。 最初は、long_query_time = 0 にして、全クエリのログをとります。もちろん、ログ採取のためのオーバヘッドはありますが、最終的にオフにすればよいです。pt-query-digestで集計するのが便利です。

### 計測環境の整備

### チューニング

> MySQL、nginx、redis、memcachedについては、特殊なお題でないかぎり、kazeburoさんのエントリの通りでよいと思います。 比較的スコアに効きやすいのは、静的ファイルのproxy配信、UNIXドメインソケット化あたりかなと思っています。

[https://kazeburo.hatenablog.com/entry/2014/10/14/170129](https://kazeburo.hatenablog.com/entry/2014/10/14/170129)

### アプリケーションの把握

#### 最初にやると良いこと

* ウェブサービスとしてブラウザからひと通りの導線を踏んでみる
* テーブルスキーマをみる
* MySQLのコンソールに入ってデータの中身をみてみる
* コードを読む

### 競技終了前のチェック

* ディスクサイズに余裕があるか。運営サイドでベンチマークを回す時にログ出力でディスクがうまることがないとも限らない。ログを吐きまくってると意外とディスクに余裕がなくなっていたりするため、最後に確認する。
* ページの表示は正常か。CSSがなぜかあたってないとかないか。
* ログの出力を切る。アクセスログやスロークエリログ。
* (厳密には競技終了30分〜60分の間ぐらい) OSごと再起動してもベンチマークが通るかどうか

## 大事なこと

* ISUCON当日に調べながらやっていては間に合わないので、今のうちに練習しておくことをおすすめします。 
* 初期状態を記録し、いつでも戻せるようにしておく
* 変更を記録し、ロールバックできる状態にしておく
